# Dev ÂàÜÊîØÊé®ÈÄÅÈÉ®ÁΩ≤È¢ÑËßà
name: Build Dev

on:
  push:
    branches:
      - dev
    paths:
      - "src/**"
      - "web/**"
      - "electron/**"
      - "public/**"
      - "package.json"
      - "pnpm-lock.yaml"
      - "electron-builder.config.ts"
      - "electron.vite.config.ts"
      - "tsconfig*.json"
      - ".env.example"
      - "Dockerfile"
      - "docker-compose.yml"
  workflow_dispatch:

env:
  NODE_VERSION: 22.x
  PNPM_VERSION: 10

jobs:
  # ===================================================================
  #  Âπ∂Ë°åÊûÑÂª∫ÊâÄÊúâÂπ≥Âè∞ÂíåÊû∂ÊûÑ
  # ===================================================================
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      # Áü©ÈòµÁ≠ñÁï•
      # Âç≥‰Ωø‰∏Ä‰∏™Áü©Èòµ‰ªªÂä°Â§±Ë¥•ÔºåÂÖ∂‰ªñ‰ªªÂä°‰πü‰ºöÁªßÁª≠ËøêË°å
      fail-fast: false
      matrix:
        os: [macos-latest, windows-latest, ubuntu-latest]
    # ÂºÄÂßãÊ≠•È™§
    steps:
      # Ê£ÄÂá∫ Git ‰ªìÂ∫ì
      - name: Check out git repository
        uses: actions/checkout@v4
      # ËÆæÁΩÆ pnpm ÁâàÊú¨
      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}
      # ÂÆâË£Ö Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"
      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
      # Ê∏ÖÁêÜÊóßÁöÑÊûÑÂª∫‰∫ßÁâ©
      - name: Clean workspace on Windows
        if: runner.os == 'Windows'
        run: |
          Write-Host "üßπ Cleaning workspace, node_modules, and Electron caches..."
          if (Test-Path dist) { Remove-Item -Recurse -Force dist }
          if (Test-Path out) { Remove-Item -Recurse -Force out }
          if (Test-Path node_modules) { Remove-Item -Recurse -Force node_modules }

          if (Test-Path "$env:LOCALAPPDATA\electron-builder") {
            Remove-Item "$env:LOCALAPPDATA\electron-builder" -Recurse -Force -ErrorAction SilentlyContinue
          }
          if (Test-Path "$env:LOCALAPPDATA\electron") {
            Remove-Item "$env:LOCALAPPDATA\electron" -Recurse -Force -ErrorAction SilentlyContinue
          }
      - name: Clean workspace on macOS & Linux
        if: runner.os == 'macOS' || runner.os == 'Linux'
        run: |
          echo "üßπ Cleaning workspace, node_modules, and Electron caches..."
          rm -rf dist out node_modules ~/.cache/electron-builder ~/.cache/electron
      # ÂÆâË£ÖÈ°πÁõÆ‰æùËµñ
      - name: Install dependencies
        run: pnpm install
      # Â§çÂà∂ÁéØÂ¢ÉÂèòÈáèÊñá‰ª∂
      - name: Copy .env file on Windows
        if: runner.os == 'Windows'
        run: |
          if (-not (Test-Path .env)) {
            Copy-Item .env.example .env
          } else {
            Write-Host ".env file already exists. Skipping the copy step."
          }
      - name: Copy .env file on macOS & Linux
        if: runner.os == 'macOS' || runner.os == 'Linux'
        run: |
          if [ ! -f .env ]; then
            cp .env.example .env
          else
            echo ".env file already exists. Skipping the copy step."
          fi
      # Êõ¥Êñ∞ Ubuntu ËΩØ‰ª∂Ê∫ê
      - name: Ubuntu Update with sudo
        if: runner.os == 'Linux'
        run: sudo apt-get update
      # ÂÆâË£Ö‰æùËµñ
      - name: Install RPM & Pacman
        if: runner.os == 'Linux'
        run: |
          sudo apt-get install --no-install-recommends -y rpm &&
          sudo apt-get install --no-install-recommends -y libarchive-tools &&
          sudo apt-get install --no-install-recommends -y libopenjp2-tools
      # ÊûÑÂª∫ Electron App
      - name: Build Windows x64 & ARM64 App
        if: runner.os == 'Windows'
        run: pnpm build:win -- --x64 --arm64
        env:
          VITE_BUILD_TYPE: dev
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Build macOS Universal App
        if: runner.os == 'macOS'
        run: pnpm build:mac -- --x64 --arm64
        shell: bash
        env:
          VITE_BUILD_TYPE: dev
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Build Linux x64 & ARM64 App
        if: runner.os == 'Linux'
        run: pnpm build:linux -- --x64 --arm64
        shell: bash
        env:
          VITE_BUILD_TYPE: dev
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ÂàÜÂà´‰∏ä‰º†
      - {
          name: Upload Artifacts - Windows Setup x64,
          if: runner.os == 'Windows',
          uses: actions/upload-artifact@v4,
          with: { name: SPlayer-Windows-setup-x64, path: dist/*-x64-setup.exe },
        }
      - {
          name: Upload Artifacts - Windows Setup arm64,
          if: runner.os == 'Windows',
          uses: actions/upload-artifact@v4,
          with:
            { name: SPlayer-Windows-setup-arm64, path: dist/*-arm64-setup.exe },
        }
      - {
          name: Upload Artifacts - Windows Portable x64,
          if: runner.os == 'Windows',
          uses: actions/upload-artifact@v4,
          with:
            {
              name: SPlayer-Windows-portable-x64,
              path: dist/*-x64-portable.exe,
            },
        }
      - {
          name: Upload Artifacts - Windows Portable arm64,
          if: runner.os == 'Windows',
          uses: actions/upload-artifact@v4,
          with:
            {
              name: SPlayer-Windows-portable-arm64,
              path: dist/*-arm64-portable.exe,
            },
        }
      - {
          name: Upload Artifacts - macOS DMG x64,
          if: runner.os == 'macOS',
          uses: actions/upload-artifact@v4,
          with: { name: SPlayer-macOS-dmg-x64, path: dist/*-x64.dmg },
        }
      - {
          name: Upload Artifacts - macOS DMG arm64,
          if: runner.os == 'macOS',
          uses: actions/upload-artifact@v4,
          with: { name: SPlayer-macOS-dmg-arm64, path: dist/*-arm64.dmg },
        }
      - {
          name: Upload Artifacts - macOS Zip x64,
          if: runner.os == 'macOS',
          uses: actions/upload-artifact@v4,
          with: { name: SPlayer-macOS-zip-x64, path: dist/*-x64.zip },
        }
      - {
          name: Upload Artifacts - macOS Zip arm64,
          if: runner.os == 'macOS',
          uses: actions/upload-artifact@v4,
          with: { name: SPlayer-macOS-zip-arm64, path: dist/*-arm64.zip },
        }
      - {
          name: Upload Artifacts - Linux AppImage x64,
          if: runner.os == 'Linux',
          uses: actions/upload-artifact@v4,
          with:
            { name: SPlayer-Linux-appimage-x64, path: dist/*-x86_64.AppImage },
        }
      - {
          name: Upload Artifacts - Linux AppImage arm64,
          if: runner.os == 'Linux',
          uses: actions/upload-artifact@v4,
          with:
            { name: SPlayer-Linux-appimage-arm64, path: dist/*-arm64.AppImage },
        }
      - {
          name: Upload Artifacts - Linux Pacman x64,
          if: runner.os == 'Linux',
          uses: actions/upload-artifact@v4,
          with: { name: SPlayer-Linux-pacman-x64, path: dist/*-x64.pacman },
        }
      - {
          name: Upload Artifacts - Linux Pacman arm64,
          if: runner.os == 'Linux',
          uses: actions/upload-artifact@v4,
          with:
            { name: SPlayer-Linux-pacman-arm64, path: dist/*-aarch64.pacman },
        }
      - {
          name: Upload Artifacts - Linux DEB x64,
          if: runner.os == 'Linux',
          uses: actions/upload-artifact@v4,
          with: { name: SPlayer-Linux-deb-x64, path: dist/*-amd64.deb },
        }
      - {
          name: Upload Artifacts - Linux DEB arm64,
          if: runner.os == 'Linux',
          uses: actions/upload-artifact@v4,
          with: { name: SPlayer-Linux-deb-arm64, path: dist/*-arm64.deb },
        }
      - {
          name: Upload Artifacts - Linux RPM x64,
          if: runner.os == 'Linux',
          uses: actions/upload-artifact@v4,
          with: { name: SPlayer-Linux-rpm-x64, path: dist/*-x86_64.rpm },
        }
      - {
          name: Upload Artifacts - Linux RPM arm64,
          if: runner.os == 'Linux',
          uses: actions/upload-artifact@v4,
          with: { name: SPlayer-Linux-rpm-arm64, path: dist/*-aarch64.rpm },
        }
      - {
          name: Upload Artifacts - Linux Tar x64,
          if: runner.os == 'Linux',
          uses: actions/upload-artifact@v4,
          with: { name: SPlayer-Linux-tar-x64, path: dist/*-x64.tar.gz },
        }
      - {
          name: Upload Artifacts - Linux Tar arm64,
          if: runner.os == 'Linux',
          uses: actions/upload-artifact@v4,
          with: { name: SPlayer-Linux-tar-arm64, path: dist/*-arm64.tar.gz },
        }
      # - {
      #     name: Upload Artifacts - Linux Snap x64,
      #     if: runner.os == 'Linux',
      #     uses: actions/upload-artifact@v4,
      #     with: { name: SPlayer-Linux-snap-x64, path: dist/*-amd64.snap },
      #   }
